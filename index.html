<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AOT Loans - User</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
header{background:#000;color:#fff;padding:15px;text-align:center}
header span{color:#f4a300}
.container{max-width:900px;margin:auto;padding:10px}
.box{background:#fff;padding:15px;margin-bottom:15px;border-radius:8px}
input,select,textarea,button{width:100%;padding:10px;margin-top:8px}
button{background:#f4a300;border:none;font-weight:bold;cursor:pointer}
small{color:#666}
#errorMsg{color:red;font-weight:bold;}
</style>
</head>
<body>

<header>
<h2>AOT <span>Loans</span></h2>
<small>Simple • Fast • Online Loans</small>
</header>

<div class="container">

<!-- Calculator -->
<div class="box">
<h3>Loan Calculator</h3>
<input id="amount" type="number" placeholder="Loan Amount (ZMW)">
<select id="duration">
<option value="">Select Duration</option>
<option value="2d">2 Days</option>
<option value="5d">5 Days</option>
<option value="1w">1 Week</option>
<option value="2w">2 Weeks</option>
<option value="1m">1 Month</option>
<option value="2m">2 Months</option>
<option value="3m">3 Months</option>
<option value="4m">4 Months</option>
<option value="5m">5 Months</option>
</select>
<p>Interest Rate: <b><span id="rate">0%</span></b></p>
<p>Total Payable: <b>ZMW <span id="total">0.00</span></b></p>
<button id="calcBtn">Calculate</button>
</div>

<!-- Loan Application -->
<div class="box">
<h3>Loan Application</h3>
<input id="name" placeholder="Full Name">
<input id="phone" placeholder="Phone Number">
<input id="nrc" placeholder="NRC Number">

<select id="status">
<option value="">Status</option>
<option>Student</option>
<option>Employed</option>
<option>Business Owner</option>
</select>

<select id="location">
<option value="">Location</option>
<option>Lusaka</option>
<option>Copperbelt</option>
<option>Central</option>
<option>Eastern</option>
<option>Northern</option>
<option>Southern</option>
<option>Western</option>
<option>Muchinga</option>
</select>

<select id="payment">
<option value="">Payment Method</option>
<option>Mobile Money</option>
<option>Bank Transfer</option>
<option>Cash</option>
</select>

<h4>Next of Kin</h4>
<input id="kinName" placeholder="Full Name">
<input id="kinPhone" placeholder="Phone Number">

<label>NRC Front</label>
<input type="file" id="nrcFront" accept="image/*">
<label>NRC Back</label>
<input type="file" id="nrcBack" accept="image/*">
<label>Face Photo</label>
<input type="file" id="facePhoto" accept="image/*">

<textarea id="purpose" placeholder="Purpose of Loan"></textarea>
<button id="submitBtn">Submit Application</button>
<p id="msg"></p>
<p id="errorMsg"></p>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
 apiKey: "AIzaSyA97oQpA05T1r_BWfnJVz9j9MmqFv7SAIw",
 authDomain: "aot-loans.firebaseapp.com",
 projectId: "aot-loans",
 storageBucket: "aot-loans.firebasestorage.app",
 messagingSenderId: "1023143461166",
 appId: "1:1023143461166:web:7025fd84b752fa26753abf"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Interest rates
const rates = {
 "2d":20,"5d":25,"1w":30,"2w":40,
 "1m":50,"2m":65,"3m":75,"4m":85,"5m":100
};

// Elements
const nameEl = document.getElementById("name");
const phoneEl = document.getElementById("phone");
const nrcEl = document.getElementById("nrc");
const statusEl = document.getElementById("status");
const locationEl = document.getElementById("location");
const paymentEl = document.getElementById("payment");
const kinNameEl = document.getElementById("kinName");
const kinPhoneEl = document.getElementById("kinPhone");
const amountEl = document.getElementById("amount");
const durationEl = document.getElementById("duration");
const purposeEl = document.getElementById("purpose");
const nrcFrontEl = document.getElementById("nrcFront");
const nrcBackEl = document.getElementById("nrcBack");
const facePhotoEl = document.getElementById("facePhoto");
const msgEl = document.getElementById("msg");
const errorEl = document.getElementById("errorMsg");
const rateEl = document.getElementById("rate");
const totalEl = document.getElementById("total");
const calcBtn = document.getElementById("calcBtn");
const submitBtn = document.getElementById("submitBtn");

// Calculator
calcBtn.addEventListener("click", ()=>{
 if(!amountEl.value || !durationEl.value){ rateEl.innerText="0%"; totalEl.innerText="0.00"; return; }
 let r = rates[durationEl.value];
 let totalPay = Number(amountEl.value) + (Number(amountEl.value) * r / 100);
 rateEl.innerText = r + "%";
 totalEl.innerText = totalPay.toFixed(2);
});

// Cloudinary Upload
async function uploadToCloudinary(file, folder){
  const url = `https://api.cloudinary.com/v1_1/dc5moeafv/upload`;
  const preset = "zedmarket"; 
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", preset);
  formData.append("folder", folder);

  try{
    const res = await fetch(url,{method:"POST",body:formData});
    const data = await res.json();
    if(data.error) throw data.error;
    return data.secure_url;
  }catch(e){
    throw new Error("Cloudinary upload failed for " + folder + ": " + JSON.stringify(e));
  }
}

// Submit Loan
submitBtn.addEventListener("click", async ()=>{
 msgEl.innerText="Submitting..."; errorEl.innerText="";

 if(!nameEl.value || !phoneEl.value || !nrcEl.value || !statusEl.value || !locationEl.value || !paymentEl.value || !kinNameEl.value || !kinPhoneEl.value || !amountEl.value || !durationEl.value || !purposeEl.value){
   errorEl.innerText="Please fill all fields!"; msgEl.innerText=""; return;
 }
 if(!nrcFrontEl.files[0] || !nrcBackEl.files[0] || !facePhotoEl.files[0]){
   errorEl.innerText="Please upload all images!"; msgEl.innerText=""; return;
 }

 try{
   const [front, back, face] = await Promise.all([
     uploadToCloudinary(nrcFrontEl.files[0],"nrcFront"),
     uploadToCloudinary(nrcBackEl.files[0],"nrcBack"),
     uploadToCloudinary(facePhotoEl.files[0],"facePhoto")
   ]);

   const r = rates[durationEl.value] || 0;
   const totalAmount = Number(amountEl.value) + (Number(amountEl.value)*r/100);

   await addDoc(collection(db,"loans"),{
     name:nameEl.value,
     phone:phoneEl.value,
     nrc:nrcEl.value,
     status:statusEl.value,
     location:locationEl.value,
     payment:paymentEl.value,
     kin:{name:kinNameEl.value, phone:kinPhoneEl.value},
     amount:Number(amountEl.value),
     duration:durationEl.value,
     rate:r,
     total:totalAmount,
     nrcFront:front,
     nrcBack:back,
     facePhoto:face,
     purpose:purposeEl.value,
     loanStatus:"Pending",
     created:new Date()
   });

   msgEl.innerText="Application submitted successfully ✔";
   errorEl.innerText="";

   // Reset form
   nameEl.value=phoneEl.value=nrcEl.value=statusEl.value=locationEl.value=paymentEl.value=kinNameEl.value=kinPhoneEl.value=amountEl.value=durationEl.value=purposeEl.value="";
   nrcFrontEl.value=nrcBackEl.value=facePhotoEl.value=null;
   rateEl.innerText="0%"; totalEl.innerText="0.00";

 }catch(err){
   console.error("Submission Error:", err);
   errorEl.innerText="Error submitting application! Check console.";
   msgEl.innerText="";
 }
});
</script>
</body>
</html>
