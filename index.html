<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AOT Loans - User</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
header{background:#000;color:#fff;padding:15px;text-align:center}
header span{color:#f4a300}
.container{max-width:900px;margin:auto;padding:10px}
.box{background:#fff;padding:15px;margin-bottom:15px;border-radius:8px}
input,select,textarea,button{width:100%;padding:10px;margin-top:8px}
button{background:#f4a300;border:none;font-weight:bold;cursor:pointer}
small{color:#666}
#errorMsg{color:red;font-weight:bold;}

canvas{
  border:2px dashed #ccc;
  width:100%;
  height:180px;
  touch-action:none;
}
.clear-btn{
  background:#444;
  color:#fff;
  margin-top:5px;
}
</style>
</head>
<body>

<header>
<h2>AOT <span>Loans</span></h2>
<small>Simple • Fast • Online Loans</small>
</header>

<div class="container">

<!-- Calculator -->
<div class="box">
<h3>Loan Calculator</h3>
<input id="amount" type="number" placeholder="Loan Amount (ZMW)" min="1000" max="20000">
<select id="duration">
<option value="">Select Duration</option>
<option value="1w">1 Week</option>
<option value="2w">2 Weeks</option>
<option value="3w">3 Weeks</option>
<option value="1m">1 Month</option>
</select>
<p>Interest Rate: <b><span id="rate">0%</span></b></p>
<p>Total Payable: <b>ZMW <span id="total">0.00</span></b></p>
<p><small>⚠ Overdue payments attract 0.5% per day</small></p>
<button id="calcBtn">Calculate</button>
<p id="errorMsg"></p>
</div>

<!-- Loan Application -->
<div class="box">
<h3>Loan Application</h3>
<input id="name" placeholder="Full Name">
<input id="phone" placeholder="Phone Number">
<input id="nrc" placeholder="NRC Number">

<select id="status">
<option value="">Status</option>
<option>Student</option>
<option>Employed</option>
<option>Business Owner</option>
</select>

<select id="location">
<option value="">Location</option>
<option>Lusaka</option>
<option>Copperbelt</option>
<option>Central</option>
<option>Eastern</option>
<option>Northern</option>
<option>Southern</option>
<option>Western</option>
<option>Muchinga</option>
</select>

<select id="payment">
<option value="">Payment Method</option>
<option>Mobile Money</option>
<option>Bank Transfer</option>
<option>Cash</option>
</select>

<h4>Next of Kin</h4>
<input id="kinName" placeholder="Full Name">
<input id="kinPhone" placeholder="Phone Number">

<label>NRC Front</label>
<input type="file" id="nrcFront" accept="image/*">
<label>NRC Back</label>
<input type="file" id="nrcBack" accept="image/*">
<label>Face Photo</label>
<input type="file" id="facePhoto" accept="image/*">

<textarea id="purpose" placeholder="Purpose of Loan"></textarea>

<h4>Applicant Signature</h4>
<small>Please sign below to confirm the information is correct</small>
<canvas id="signature"></canvas>
<button type="button" class="clear-btn" id="clearSign">Clear Signature</button>

<button id="submitBtn">Submit Application</button>
<p id="msg"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase
const firebaseConfig = {
 apiKey: "AIzaSyA97oQpA05T1r_BWfnJVz9j9MmqFv7SAIw",
 authDomain: "aot-loans.firebaseapp.com",
 projectId: "aot-loans",
 storageBucket: "aot-loans.firebasestorage.app",
 messagingSenderId: "1023143461166",
 appId: "1:1023143461166:web:7025fd84b752fa26753abf"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Interest rates
const rates = {"1w":15,"2w":25,"3w":30,"1m":40};

// Elements
const amountEl = document.getElementById("amount");
const durationEl = document.getElementById("duration");
const rateEl = document.getElementById("rate");
const totalEl = document.getElementById("total");
const errorEl = document.getElementById("errorMsg");
const msgEl = document.getElementById("msg");

// Calculator
document.getElementById("calcBtn").onclick=()=>{
 const a=Number(amountEl.value);
 if(!a||!durationEl.value) return;
 const r=rates[durationEl.value];
 rateEl.innerText=r+"%";
 totalEl.innerText=(a+a*r/100).toFixed(2);
};

// Signature pad
const canvas=document.getElementById("signature");
const ctx=canvas.getContext("2d");
canvas.width=canvas.offsetWidth;
canvas.height=180;
let drawing=false;

canvas.onmousedown=e=>{drawing=true;ctx.moveTo(e.offsetX,e.offsetY);}
canvas.onmousemove=e=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}}
canvas.onmouseup=()=>drawing=false;
canvas.ontouchstart=e=>{
 e.preventDefault();
 drawing=true;
 const t=e.touches[0];
 ctx.moveTo(t.clientX-canvas.offsetLeft,t.clientY-canvas.offsetTop);
}
canvas.ontouchmove=e=>{
 e.preventDefault();
 if(!drawing) return;
 const t=e.touches[0];
 ctx.lineTo(t.clientX-canvas.offsetLeft,t.clientY-canvas.offsetTop);
 ctx.stroke();
}
canvas.ontouchend=()=>drawing=false;

document.getElementById("clearSign").onclick=()=>{
 ctx.clearRect(0,0,canvas.width,canvas.height);
};

// Cloudinary upload
async function uploadToCloudinary(file,folder){
 const url="https://api.cloudinary.com/v1_1/dc5moeafv/upload";
 const fd=new FormData();
 fd.append("file",file);
 fd.append("upload_preset","zedmarket");
 fd.append("folder",folder);
 const r=await fetch(url,{method:"POST",body:fd});
 const d=await r.json();
 return d.secure_url;
}

// Submit
document.getElementById("submitBtn").onclick=async()=>{
 msgEl.innerText="Submitting...";
 const signData=canvas.toDataURL();
 if(signData.length<2000){
   errorEl.innerText="Please provide your signature!";
   msgEl.innerText="";
   return;
 }

 const signBlob=await (await fetch(signData)).blob();
 const signURL=await uploadToCloudinary(signBlob,"signatures");

 await addDoc(collection(db,"loans"),{
   amount:Number(amountEl.value),
   duration:durationEl.value,
   signature:signURL,
   created:new Date(),
   loanStatus:"Pending"
 });

 msgEl.innerText="Application submitted successfully ✔";
 errorEl.innerText="";
};
</script>
</body>
</html>
